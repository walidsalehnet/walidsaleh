<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div id="ordersContainer"></div>

    <!-- ØªØ­Ù…ÙŠÙ„ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="main.js"></script>

    <script>
        function loadOrders(userId) {
            const ordersContainer = document.getElementById("ordersContainer");
            ordersContainer.innerHTML = "<p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>";

            db.collection("orders").where("userId", "==", userId).get().then((querySnapshot) => {
                ordersContainer.innerHTML = "";
                if (querySnapshot.empty) {
                    ordersContainer.innerHTML = "<p>ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    let order = doc.data();
                    let orderElement = document.createElement("div");
                    orderElement.innerHTML = `
                        <h3>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.orderId}</h3>
                        <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${order.phoneNumber}</p>
                        <p>ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨: ${order.whatsappNumber}</p>
                        <p>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ…: <strong>${order.amountDeducted} Ø¬Ù†ÙŠÙ‡</strong></p>
                        <p>ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${order.status}</strong></p>
                        ${order.status === "Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ù„ØºØ§Ø¡" ? `<button onclick="cancelOrder(${order.orderId}, ${order.amountDeducted}, '${userId}')">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>` : ""}
                        <hr>
                    `;
                    ordersContainer.appendChild(orderElement);
                });
            });
        }

        function cancelOrder(orderId, amount, userId) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

            const userRef = db.collection("users").doc(userId);

            db.runTransaction((transaction) => {
                return transaction.get(userRef).then((userDoc) => {
                    if (!userDoc.exists) throw "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";
                    let currentWallet = userDoc.data().wallet || 0;
                    transaction.update(userRef, { wallet: currentWallet + amount });
                    return transaction;
                });
            }).then(() => {
                return db.collection("orders").where("orderId", "==", orderId).get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        doc.ref.delete();
                    });
                });
            }).then(() => {
                alert(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ${amount.toFixed(2)} Ø¬Ù†ÙŠÙ‡ Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ.`);
                loadOrders(userId);
            }).catch(error => {
                console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨:", error);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.");
            });
        }

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                loadOrders(user.uid);
            } else {
                document.getElementById("ordersContainer").innerHTML = "<p>âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>";
            }
        });
    </script>
</body>
</html>
