<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</title>

    <!-- âœ… ØªØ­Ù…ÙŠÙ„ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // âœ… ØªÙƒÙˆÙŠÙ† Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAdf5AKFgLXgK2PYERHw1hgF_HsMmuTfuo",
            authDomain: "noproblem-55b97.firebaseapp.com",
            projectId: "noproblem-55b97",
            storageBucket: "noproblem-55b97.appspot.com",
            messagingSenderId: "316010224446",
            appId: "1:316010224446:web:5d7e7f792e53ee4b396a6f",
            measurementId: "G-VKSGWBRKVL"
        };

        // âœ… ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #2d2d2d, #3b3b3b);
            font-family: 'Cairo', sans-serif;
            color: white;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
            margin: auto;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        select, input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4a4a4a, #2e2e2e);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.3s;
        }

        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        .message-box {
            width: 90%;
            max-width: 450px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 10px;
            text-align: center;
            margin: 15px auto;
            display: none;
        }

        table {
            width: 90%;
            max-width: 600px;
            border-collapse: collapse;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            border: 1px solid white;
            text-align: center;
        }

        th {
            background: rgba(255, 255, 255, 0.3);
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ’° Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</h1>

        <label>ğŸ“² Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø³Ø­Ø¨:</label>
        <input type="tel" id="withdrawNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„ÙŠÙ‡">

        <label>ğŸ“ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„:</label>
        <input type="tel" id="whatsappNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">

        <label>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</label>
        <input type="number" id="amount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨Ù‡">

        <button class="button" onclick="submitWithdraw()">âš¡ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>
    </div>

    <div id="messageBox" class="message-box"></div>

    <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø­Ø¨</h2>
    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø­Ø¨</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
    </table>

    <script>
        function fetchOrders() {
            const ordersTable = document.getElementById("ordersTable");
            ordersTable.innerHTML = "";

            db.collection("requests")
              .where("type", "==", "Ø³Ø­Ø¨")
              .orderBy("createdAt", "desc")
              .onSnapshot(snapshot => {
                ordersTable.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    ordersTable.innerHTML += `
                        <tr>
                            <td>${data.orderId}</td>
                            <td>${data.receiverPhone}</td>
                            <td>${data.whatsappNumber}</td>
                            <td>${data.amount} Ø¬Ù†ÙŠÙ‡</td>
                            <td>${data.status || "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"}</td>
                        </tr>
                    `;
                });
            });
        }

        function submitWithdraw() {
            const withdrawNumber = document.getElementById("withdrawNumber").value;
            const whatsappNumber = document.getElementById("whatsappNumber").value;
            const amount = parseFloat(document.getElementById("amount").value);
            const orderId = Math.floor(100000 + Math.random() * 900000);

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    const userRef = db.collection("users").doc(user.uid);

                    userRef.get().then(doc => {
                        if (doc.exists) {
                            let walletBalance = doc.data().wallet || 0;
                            let email = doc.data().email || "ØºÙŠØ± Ù…ØªÙˆÙØ±";

                            if (amount > walletBalance) {
                                showMessage(`âŒ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙˆÙØ± Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ ${walletBalance} Ø¬Ù†ÙŠÙ‡ ÙÙ‚Ø·!`, "red");
                                return;
                            }

                            userRef.update({ wallet: walletBalance - amount }).then(() => {
                                db.collection("requests").doc(orderId.toString()).set({
                                    orderId: orderId,
                                    userId: user.uid,
                                    userEmail: email,
                                    senderPhone: "Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©",
                                    receiverPhone: withdrawNumber,
                                    whatsappNumber: whatsappNumber,
                                    amount: amount,
                                    type: "Ø³Ø­Ø¨",
                                    status: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => {
                                    showMessage("âœ… ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!", "green");
                                    sendToTelegram(orderId, withdrawNumber, whatsappNumber, amount, email);
                                    fetchOrders();
                                });
                            });
                        }
                    });
                }
            });
        }

        function sendToTelegram(orderId, withdrawNumber, whatsappNumber, amount, email) {
            let message = `ğŸ“¢ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ“¢\n\n`
                + `ğŸ†” *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:* ${orderId}\n`
                + `ğŸ“² *Ø±Ù‚Ù… Ø§Ù„Ø³Ø­Ø¨:* ${withdrawNumber}\n`
                + `ğŸ“ *ÙˆØ§ØªØ³Ø§Ø¨:* ${whatsappNumber}\n`
                + `ğŸ’° *Ø§Ù„Ù…Ø¨Ù„Øº:* ${amount} Ø¬Ù†ÙŠÙ‡\n`
                + `âœ‰ï¸ *Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:* ${email}`;

            let botToken = "7722994458:AAGu0YZhu67iuNc_sxrOf9oQKE0kJTtbjLI";
            let chatId = "8102839626";

            let url = `https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        showMessage("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!", "green");
                    } else {
                        showMessage("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…!", "red");
                        console.error("Telegram Error:", data);
                    }
                })
                .catch(error => {
                    showMessage("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!", "red");
                    console.error("Fetch Error:", error);
                });
        }

        function showMessage(msg, color) {
            const box = document.getElementById("messageBox");
            box.innerText = msg;
            box.style.background = color;
            box.style.display = "block";
            setTimeout(() => { box.style.display = "none"; }, 4000);
        }

        document.addEventListener("DOMContentLoaded", fetchOrders);
    </script>

</body>
</html>
